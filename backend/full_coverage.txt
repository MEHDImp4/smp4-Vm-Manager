
> web-backend@1.0.0 test
> jest --coverage --coverage --detectOpenHandles

PASS __tests__/unit/instanceController.test.js (7.123 s)
  Instance Controller Unit Tests
    toggleInstanceStatus
      ΓêÜ should stop a running instance (4 ms)
      ΓêÜ should start a stopped instance (1 ms)
      ΓêÜ should return 404 if instance not found (1 ms)
    restartInstance
      ΓêÜ should reboot instance (1 ms)
    deleteInstance
      ΓêÜ should delete instance and cleanup resources (3008 ms)
      ΓêÜ should handle errors during stop gracefully
      ΓêÜ should handle errors during proxmox delete gracefully (3013 ms)
    getInstanceStats
      ΓêÜ should return stats for running instance (1 ms)
      ΓêÜ should return zero stats for stopped instance (1 ms)
      ΓêÜ should handle proxmox errors by returning zeros/unknown (1 ms)
    createDomain
      ΓêÜ should create a domain successfully (1 ms)
      ΓêÜ should validate inputs (1 ms)
    deleteDomain
      ΓêÜ should delete domain successfully (1 ms)
      ΓêÜ should return 404 if domain not found (1 ms)
    getDomains
      ΓêÜ should return domains
      ΓêÜ should return 404 if instance not found (1 ms)
    getVpnConfig
      ΓêÜ should return existing config (1 ms)
      ΓêÜ should generate config if missing and instance has IP (1 ms)
    createInstance
      ΓêÜ should create instance successfully (2 ms)
      ΓêÜ should return 400 for invalid template (1 ms)
      ΓêÜ should return 500 on db error (1 ms)

PASS __tests__/integration/instance.routes.test.js
  Instance Routes
    GET /api/instances
      ΓêÜ should get all user instances (49 ms)
    POST /api/instances
      ΓêÜ should create new instance (36 ms)
    DELETE /api/instances/:id
      ΓêÜ should delete instance (3010 ms)
      ΓêÜ should return 403 if trying to delete others instance (8 ms)

PASS __tests__/integration/auth.routes.test.js
  Auth Routes
    POST /api/auth/register
      ΓêÜ should register a new user (16 ms)
      ΓêÜ should return 400 if user already exists (8 ms)
      ΓêÜ should return 400 if fields are missing (8 ms)
    POST /api/auth/login
      ΓêÜ should login user successfully (8 ms)
      ΓêÜ should return 401 if user not found (16 ms)
      ΓêÜ should return 400 if fields are missing (7 ms)

PASS __tests__/integration/template.routes.test.js
  Template Routes
    GET /api/templates
      ΓêÜ should get all templates (9 ms)
      ΓêÜ should return empty array if no templates exist (16 ms)

PASS __tests__/integration/points.routes.test.js
  Points Routes
    POST /api/points/spin
      ΓêÜ should spin and potentially earn points (19 ms)
      ΓêÜ should return 400 if already spun today (8 ms)

PASS __tests__/unit/proxmox.service.test.js
  ProxmoxService
    getLXCList
      ΓêÜ should return list of LXC containers (1 ms)
      ΓêÜ should throw error when fetching LXC list fails (12 ms)
    getNextVmid
      ΓêÜ should return next available VMID (1 ms)
      ΓêÜ should throw error when fetching next VMID fails (1 ms)
    cloneLXC
      ΓêÜ should clone LXC container successfully (1 ms)
      ΓêÜ should throw error when cloning fails
    startLXC
      ΓêÜ should start LXC container
    stopLXC
      ΓêÜ should stop LXC container (1 ms)
    configureLXC
      ΓêÜ should configure LXC container (1 ms)
    getLXCStatus
      ΓêÜ should get LXC status
      ΓêÜ should throw error if get status fails
    getLXCInterfaces
      ΓêÜ should get LXC interfaces (1 ms)
      ΓêÜ should return empty array on error (1 ms)
    deleteLXC
      ΓêÜ should delete LXC container (1 ms)
    waitForTask
      ΓêÜ should resolve when task is stopped and OK
      ΓêÜ should reject when task fails (1 ms)
    Snapshot Methods
      ΓêÜ should create snapshot (1 ms)
      ΓêÜ should list snapshots (1 ms)
      ΓêÜ should delete snapshot (1 ms)
      ΓêÜ should rollback snapshot (1 ms)
    Backup Methods
      ΓêÜ should create backup (1 ms)
      ΓêÜ should list backups
      ΓêÜ should delete backup
      ΓêÜ should get backup download ticket (1 ms)
      ΓêÜ should fallback to volid if ticket fails
    Firewall Methods
      ΓêÜ should add firewall rule (1 ms)
      ΓêÜ should set firewall options (1 ms)
    rebootLXC
      ΓêÜ should reboot LXC container (1 ms)
      ΓêÜ should throw error when reboot fails
    getLXCConfig
      ΓêÜ should get LXC config (1 ms)
      ΓêÜ should throw error when get config fails (1 ms)

PASS __tests__/unit/cloudflare.service.test.js
  CloudflareService
    addTunnelIngress
      ΓêÜ should add tunnel ingress successfully (5 ms)
      ΓêÜ should throw error when adding ingress fails (8 ms)
    removeTunnelIngress
      ΓêÜ should remove tunnel ingress successfully (4 ms)
      ΓêÜ should throw error when removing ingress fails (3 ms)

PASS __tests__/unit/snapshotCron.test.js
  Snapshot Cron
    ΓêÜ should initialize snapshot cron (27 ms)
    ΓêÜ should create snapshots for instances with vmid (1 ms)
    ΓêÜ should handle snapshot errors gracefully (1 ms)
    ΓêÜ should skip instances without vmid

PASS __tests__/unit/vpn.service.test.js
  VpnService
    createClient
      ΓêÜ should create VPN client and return config (1 ms)
      ΓêÜ should throw error when VPN client creation fails (4 ms)
    deleteClient
      ΓêÜ should delete VPN client successfully (1 ms)

PASS __tests__/unit/snapshotController.test.js
  Snapshot Controller Unit Tests
    createSnapshot
      ΓêÜ should create a snapshot successfully (2 ms)
      ΓêÜ should rotate snapshots if limit reached (delete oldest) (1 ms)
    getSnapshots
      ΓêÜ should return list of snapshots (1 ms)
    restoreSnapshot
      ΓêÜ should restore snapshot (1 ms)
    deleteSnapshot
      ΓêÜ should delete snapshot (1 ms)

PASS __tests__/unit/ssh.service.test.js
  SSHService
    init
      ΓêÜ should initialize WebSocket server (2 ms)
      ΓêÜ should handle incoming connections (1 ms)
      ΓêÜ should reject missing params (1 ms)
    createSSHSession
      ΓêÜ should create session and handle auth flow (1 ms)
      ΓêÜ should handle ready event and shell creation
      ΓêÜ should handle shell data and closing (1 ms)
      ΓêÜ should handle keyboard interactive (1 ms)
      ΓêÜ should handle client error (2 ms)
    execCommand
      ΓêÜ should execute command and return stdout (21 ms)
      ΓêÜ should reject on connection error (19 ms)

PASS __tests__/unit/authMiddleware.test.js
  Auth Middleware
    ΓêÜ should extract user from valid token and call next (2 ms)
    ΓêÜ should reject request without authorization header (1 ms)
    ΓêÜ should reject request with valid header but invalid token (verification fail) (1 ms)

PASS __tests__/unit/consumptionCron.test.js
  Consumption Cron
    ΓêÜ should initialize cron job (3 ms)
    ΓêÜ should process consumption on schedule (1 ms)

PASS __tests__/unit/pointsService.test.js
  PointsService
    deductPoints
      ΓêÜ should deduct points from users with online instances (2 ms)
      ΓêÜ should stop instances when points reach zero (1 ms)

PASS __tests__/unit/pointsController.test.js
  Points Controller Unit Tests
    spinWheel
      ΓêÜ should allow user to spin if they have not spun today (2 ms)
      ΓêÜ should return 400 if user already spun today (1 ms)
      ΓêÜ should handle errors gracefully (1 ms)
    canSpinToday
      ΓêÜ should return true if no spin today (1 ms)
      ΓêÜ should return false if already spun (1 ms)
      ΓêÜ should handle errors
    purchasePoints
      ΓêÜ should return placeholder response for valid amount (1 ms)
      ΓêÜ should return 400 for invalid amount (1 ms)
      ΓêÜ should handle errors
    claimSocialBonus
      ΓêÜ should claim bonus if platform is valid and not yet claimed (1 ms)
      ΓêÜ should return 400 if platform is invalid (1 ms)
      ΓêÜ should return 400 if bonus already claimed (1 ms)
      ΓêÜ should handle errors

------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------
File                    | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                           
------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------
All files               |   70.18 |    51.27 |   79.48 |   70.72 |                                                                                                                             
 controllers            |   67.88 |    57.72 |   74.41 |   68.52 |                                                                                                                             
  authController.js     |   44.15 |    51.72 |   33.33 |   44.73 | 40-41,62,78-79,84-102,109-134,139-156,161-171                                                                               
  instanceController.js |   69.42 |    58.39 |   79.16 |   70.43 | 100,120-273,320-321,359-360,374,381-382,444-445,457,527-528,540,563,571,589,598,619-620,650-651,681-682,694,704,713,728-734 
  pointsController.js   |     100 |      100 |     100 |     100 |                                                                                                                             
  snapshotController.js |   59.81 |       45 |   66.66 |   60.37 | 20,24,36,75-76,92,107-108,124,132,136,144-145,154-155,165-166,182,190,199,209-210,216-274                                   
  templateController.js |      75 |      100 |     100 |      75 | 10-11                                                                                                                       
 cron                   |   57.57 |       50 |   66.66 |   57.57 |                                                                                                                             
  consumptionCron.js    |      90 |       50 |   66.66 |      90 | 13                                                                                                                          
  snapshotCron.js       |   43.47 |       50 |   66.66 |   43.47 | 14-47                                                                                                                       
 middlewares            |     100 |    83.33 |     100 |     100 |                                                                                                                             
  authMiddleware.js     |     100 |    83.33 |     100 |     100 | 12                                                                                                                          
 routes                 |    79.1 |        0 |       0 |    79.1 |                                                                                                                             
  authRoutes.js         |   54.83 |        0 |       0 |   54.83 | 13-25,33-39                                                                                                                 
  instanceRoutes.js     |     100 |      100 |     100 |     100 |                                                                                                                             
  pointsRoutes.js       |     100 |      100 |     100 |     100 |                                                                                                                             
  templateRoutes.js     |     100 |      100 |     100 |     100 |                                                                                                                             
 services               |    72.2 |    44.61 |   88.88 |   72.72 |                                                                                                                             
  cloudflare.service.js |   85.36 |    67.85 |     100 |   84.61 | 27,52-53,78,88-89                                                                                                           
  email.service.js      |   30.76 |        0 |       0 |   30.76 | 22-66                                                                                                                       
  pointsService.js      |   95.23 |    83.33 |     100 |   95.23 | 84                                                                                                                          
  proxmox.service.js    |   77.51 |    37.93 |     100 |   77.16 | 10,67-68,88-89,98-99,140-141,158-161,184-185,201-202,218-219,236-237,260-261,282-283,299-300,337-338,355-356                
  ssh.service.js        |   63.52 |    40.65 |   78.57 |    64.7 | 28,85-87,118-127,157-197,210-211,217-224,229-230,239,257-258,267,274-279,289                                                
  vpn.service.js        |   81.81 |    66.66 |     100 |   85.71 | 24-25,35                                                                                                                    
------------------------|---------|----------|---------|---------|-----------------------------------------------------------------------------------------------------------------------------
Test Suites: 15 passed, 15 total
Tests:       112 passed, 112 total
Snapshots:   0 total
Time:        12.693 s
Ran all test suites.

Jest has detected the following 2 open handles potentially keeping Jest from exiting:

  ΓùÅ  Timeout

      11 | const startSnapshotCron = () => {
      12 |     // Run every day at midnight (00:00)
    > 13 |     cron.schedule('0 0 * * *', async () => {
         |          ^
      14 |         log('[Cron] Starting daily snapshot task...');
      15 |         try {
      16 |             // Fetch all instances that are likely active (e.g. not deleted)

      at Runner.start (node_modules/node-cron/src/scheduler/runner.ts:167:29)
      at InlineScheduledTask.start (node_modules/node-cron/src/tasks/inline-scheduled-task.ts:89:19)
      at Object.schedule (node_modules/node-cron/src/node-cron.ts:46:10)
      at schedule (src/cron/snapshotCron.js:13:10)
      at startSnapshotCron (__tests__/unit/snapshotCron.test.js:17:7)
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.toThrow (__tests__/unit/snapshotCron.test.js:18:12)


  ΓùÅ  Timeout

      10 | const startConsumptionCron = () => {
      11 |     // Run every minute
    > 12 |     cron.schedule('* * * * *', () => {
         |          ^
      13 |         deductPoints();
      14 |     });
      15 |     log('Consumption cron job started.');

      at Runner.start (node_modules/node-cron/src/scheduler/runner.ts:167:29)
      at InlineScheduledTask.start (node_modules/node-cron/src/tasks/inline-scheduled-task.ts:89:19)
      at Object.schedule (node_modules/node-cron/src/node-cron.ts:46:10)
      at schedule (src/cron/consumptionCron.js:12:10)
      at startConsumptionCron (__tests__/unit/consumptionCron.test.js:14:7)
      at Object.<anonymous> (node_modules/expect/build/toThrowMatchers.js:74:11)
      at Object.throwingMatcher [as toThrow] (node_modules/expect/build/index.js:320:21)
      at Object.toThrow (__tests__/unit/consumptionCron.test.js:15:12)

