
> web-backend@1.0.0 test
> jest --coverage __tests__/unit/instanceController.test.js

PASS __tests__/unit/instanceController.test.js (6.771 s)
  Instance Controller Unit Tests
    toggleInstanceStatus
      ΓêÜ should stop a running instance (4 ms)
      ΓêÜ should start a stopped instance (1 ms)
      ΓêÜ should return 404 if instance not found (1 ms)
    restartInstance
      ΓêÜ should reboot instance (1 ms)
    deleteInstance
      ΓêÜ should delete instance and cleanup resources (3009 ms)
      ΓêÜ should handle errors during stop gracefully
      ΓêÜ should handle errors during proxmox delete gracefully (3003 ms)
    getInstanceStats
      ΓêÜ should return stats for running instance (1 ms)
      ΓêÜ should return zero stats for stopped instance (1 ms)
      ΓêÜ should handle proxmox errors by returning zeros/unknown (1 ms)
    createDomain
      ΓêÜ should create a domain successfully (1 ms)
      ΓêÜ should validate inputs (1 ms)
    deleteDomain
      ΓêÜ should delete domain successfully
      ΓêÜ should return 404 if domain not found
    getDomains
      ΓêÜ should return domains (1 ms)
      ΓêÜ should return 404 if instance not found
    getVpnConfig
      ΓêÜ should return existing config (1 ms)
      ΓêÜ should generate config if missing and instance has IP (1 ms)
    createInstance
      ΓêÜ should create instance successfully (2 ms)
      ΓêÜ should return 400 for invalid template (1 ms)
      ΓêÜ should return 500 on db error

------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------
File                    | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s                                                                                                                          
------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------
All files               |   15.16 |    14.33 |   11.58 |   15.35 |                                                                                                                                            
 controllers            |   23.35 |    23.49 |   23.94 |   23.73 |                                                                                                                                            
  adminController.js    |       0 |        0 |       0 |       0 | 1-251                                                                                                                                      
  authController.js     |       0 |        0 |       0 |       0 | 1-393                                                                                                                                      
  contactController.js  |       0 |        0 |       0 |       0 | 1-150                                                                                                                                      
  instanceController.js |   63.63 |    55.78 |   70.83 |   64.52 | 31,106,124-323,337-365,403-404,418,425-426,440,479,491-492,504,578,595-596,608,631,639,657,666,687-688,718-719,749-750,762,772,781,796-802 
  pointsController.js   |       0 |        0 |       0 |       0 | 1-271                                                                                                                                      
  snapshotController.js |       0 |        0 |       0 |       0 | 1-361                                                                                                                                      
  templateController.js |       0 |      100 |       0 |       0 | 1-15                                                                                                                                       
 cron                   |       0 |        0 |       0 |       0 |                                                                                                                                            
  backup.cron.js        |       0 |        0 |       0 |       0 | 1-85                                                                                                                                       
  consumptionCron.js    |       0 |        0 |       0 |       0 | 1-18                                                                                                                                       
  idleCheck.cron.js     |       0 |        0 |       0 |       0 | 1-95                                                                                                                                       
  reminder.cron.js      |       0 |        0 |       0 |       0 | 1-76                                                                                                                                       
  snapshotCron.js       |       0 |        0 |       0 |       0 | 1-54                                                                                                                                       
 middlewares            |       0 |        0 |       0 |       0 |                                                                                                                                            
  adminMiddleware.js    |       0 |        0 |       0 |       0 | 1-15                                                                                                                                       
  authMiddleware.js     |       0 |        0 |       0 |       0 | 1-20                                                                                                                                       
 routes                 |       0 |        0 |       0 |       0 |                                                                                                                                            
  adminRoutes.js        |       0 |      100 |     100 |       0 | 1-18                                                                                                                                       
  authRoutes.js         |       0 |        0 |       0 |       0 | 1-58                                                                                                                                       
  contactRoutes.js      |       0 |      100 |     100 |       0 | 1-15                                                                                                                                       
  instanceRoutes.js     |       0 |      100 |     100 |       0 | 1-31                                                                                                                                       
  pointsRoutes.js       |       0 |      100 |     100 |       0 | 1-16                                                                                                                                       
  templateRoutes.js     |       0 |      100 |     100 |       0 | 1-11                                                                                                                                       
 services               |    6.43 |     3.04 |    2.73 |    6.65 |                                                                                                                                            
  cloudflare.service.js |   13.79 |     7.31 |       0 |   14.81 | 26-140                                                                                                                                     
  email.service.js      |   13.15 |        0 |       0 |   13.15 | 22-92,104-121,129-483                                                                                                                      
  pointsService.js      |       0 |        0 |       0 |       0 | 1-112                                                                                                                                      
  proxmox.service.js    |    4.89 |     6.25 |    3.44 |       5 | 10,26-391                                                                                                                                  
  ssh.service.js        |    2.51 |        0 |    3.57 |    2.61 | 14-293                                                                                                                                     
  vpn.service.js        |   22.72 |        0 |       0 |    23.8 | 6-12,17-35                                                                                                                                 
------------------------|---------|----------|---------|---------|--------------------------------------------------------------------------------------------------------------------------------------------
Jest: "global" coverage threshold for statements (50%) not met: 15.16%
Jest: "global" coverage threshold for branches (50%) not met: 14.33%
Jest: "global" coverage threshold for lines (50%) not met: 15.35%
Jest: "global" coverage threshold for functions (50%) not met: 11.58%
Test Suites: 1 passed, 1 total
Tests:       21 passed, 21 total
Snapshots:   0 total
Time:        8.305 s
Ran all test suites matching /__tests__\\unit\\instanceController.test.js/i.
Jest did not exit one second after the test run has completed.

'This usually means that there are asynchronous operations that weren't stopped in your tests. Consider running Jest with `--detectOpenHandles` to troubleshoot this issue.
