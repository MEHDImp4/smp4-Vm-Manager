generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  password   String
  points     Float    @default(100.0)
  created_at DateTime @default(now())
  avatarUrl  String?

  instances  Instance[]
  transactions PointTransaction[]

  @@map("users")
}

model PointTransaction {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Float    // Negative for deduction, Positive for recharge
  type      String   // "usage", "recharge", "bonus"
  createdAt DateTime @default(now())

  @@map("point_transactions")
}

model Instance {
  id           String   @id @default(uuid())
  vmid         Int?     @unique // Proxmox VMID
  name         String
  template     String
  cpu          String
  ram          String
  storage      String
  pointsPerDay Float
  status       String   @default("stopped") // "online" or "stopped"
  vpnConfig    String?  // WireGuard Client Configuration
  rootPassword String?  // Optional root password generated on creation
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  created_at   DateTime @default(now())

  snapshots    Snapshot[]
  domains      Domain[]

  @@map("instances")
}

model Snapshot {
  id              String   @id @default(uuid())
  instanceId      String
  instance        Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  name            String   // User-friendly name
  proxmoxSnapName String   // Internal Proxmox snapshot name (e.g., snap_1702684800)
  description     String?
  createdAt       DateTime @default(now())

  @@map("snapshots")
}

model Domain {
  id         String   @id @default(uuid())
  subdomain  String   // e.g. "minecraft"
  port       Int      // e.g. 25565
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([subdomain]) // Ensure unique subdomains globally
  @@map("domains")
}

model Template {
  id      String @id
  name    String
  cpu     String
  ram     String
  storage String
  points  Float

  versions TemplateVersion[]

  @@map("templates")
}

model TemplateVersion {
  id         Int      @id @default(autoincrement())
  templateId String
  template   Template @relation(fields: [templateId], references: [id])
  os         String   // "ubuntu", "debian"
  proxmoxId  Int      // The ID of the template in Proxmox (e.g., 100, 101)

  @@unique([templateId, os])
  @@map("template_versions")
}
