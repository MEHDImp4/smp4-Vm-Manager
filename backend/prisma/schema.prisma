generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id         Int      @id @default(autoincrement())
  name       String
  email      String   @unique
  password   String
  points     Float    @default(0.0)
  created_at DateTime @default(now())
  avatarUrl  String?
  role       String   @default("user") // "user", "admin"
  isVerified Boolean  @default(false)
  verificationCode String?
  isBanned   Boolean  @default(false)
  banReason  String?
  banExpiresAt DateTime?
  isDeleted  Boolean  @default(false)

  instances    Instance[]
  transactions PointTransaction[]
  dailySpins   DailySpin[]
  socialClaims SocialClaim[]

  @@map("users")
}

model PointTransaction {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Float // Negative for deduction, Positive for recharge
  type      String // "usage", "recharge", "bonus", "spin", "social", "purchase"
  createdAt DateTime @default(now())

  @@map("point_transactions")
}

model DailySpin {
  id       String   @id @default(uuid())
  userId   Int
  user     User     @relation(fields: [userId], references: [id])
  points   Float // Points won (10-200)
  spinDate DateTime @default(now())

  @@map("daily_spins")
}

model Instance {
  id                   String    @id @default(uuid())
  vmid                 Int?      @unique // Proxmox VMID
  name                 String
  template             String
  cpu                  String
  ram                  String
  storage              String
  pointsPerDay         Float
  status               String    @default("stopped") // "online" or "stopped"
  vpnConfig            String? // WireGuard Client Configuration
  rootPassword         String? // Optional root password generated on creation
  lastIdleNotification DateTime? // Track last time we sent "turn off your VM" email
  userId               Int
  user                 User      @relation(fields: [userId], references: [id])
  created_at           DateTime  @default(now())

  snapshots Snapshot[]
  domains   Domain[]

  @@map("instances")
}

model Snapshot {
  id              String   @id @default(uuid())
  instanceId      String
  instance        Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  name            String // User-friendly name
  proxmoxSnapName String // Internal Proxmox snapshot name (e.g., snap_1702684800)
  description     String?
  createdAt       DateTime @default(now())

  @@map("snapshots")
}

model Domain {
  id         String   @id @default(uuid())
  subdomain  String // e.g. "minecraft"
  port       Int // e.g. 25565
  isPaid     Boolean  @default(false) // Premium domain (2pts/day) beyond free limit
  instanceId String
  instance   Instance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([subdomain]) // Ensure unique subdomains globally
  @@map("domains")
}

model Template {
  id      String @id
  name    String
  cpu     String
  ram     String
  storage String
  points  Float
  oldPrice Float?

  versions TemplateVersion[]

  @@map("templates")
}

model TemplateVersion {
  id         Int      @id @default(autoincrement())
  templateId String
  template   Template @relation(fields: [templateId], references: [id])
  os         String // "ubuntu", "debian"
  proxmoxId  Int // The ID of the template in Proxmox (e.g., 100, 101)

  @@unique([templateId, os])
  @@map("template_versions")
}

model SocialClaim {
  id        String   @id @default(uuid())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  platform  String // "github", "twitter", "linkedin"
  username  String
  status    String   @default("verified") // "verified", "pending", "rejected"
  createdAt DateTime @default(now())

  @@unique([userId, platform])
  @@map("social_claims")
}

model DeletedUser {
  id        Int      @id @default(autoincrement())
  email     String
  name      String
  role      String
  userData  String   // JSON dump of other fields if needed
  deletedAt DateTime @default(now())

  @@map("deleted_users")
}

model Message {
  id        String   @id @default(uuid())
  name      String
  email     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("messages")
}
